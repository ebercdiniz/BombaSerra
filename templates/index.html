{% load static %}
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Controle de Bombas</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 2rem; background: #f0f4f8; text-align: center; }
      h1 { margin-bottom: 2rem; }
      .bomb-row { margin-bottom: 2rem; display: inline-block; }
      .bomb-img { width: 320px; height: 320px; cursor: pointer; border-radius: 12px; border: 2px solid #ccc; transition: transform 0.2s; }
      .bomb-img:hover { transform: scale(1.05); }
      .status { margin-top: 2rem; font-weight: bold; font-size: 1.2rem; }
    </style>
  </head>
  <body>
    <h1>Controle de Bombas</h1>

    <div class="bomb-row">
      <p>Bomba do Ronaldo</p>
      <img id="ronaldo-img" class="bomb-img" src="{% static 'torneira_off.png' %}" alt="Bomba Ronaldo">
    </div>

    <div class="bomb-row">
      <p>Bomba do Seu Nenê</p>
      <img id="nene-img" class="bomb-img" src="{% static 'torneira_off.png' %}" alt="Bomba Seu Nene">
    </div>

    <div class="bomb-row">
      <p>Bomba do Eber/Abel</p>
      <img id="eber-img" class="bomb-img" src="{% static 'torneira_off.png' %}" alt="Bomba Eber/Abel">
    </div>

    <br><br>
    <div class="bomb-row">
      <p>Bomba D'água</p>
      <img id="agua-img" class="bomb-img" src="{% static 'motor_off.png' %}" alt="Bomba D'água">
    </div>

    <div class="bomb-row">
      <p>ESP32</p>
      <img id="esp32-img" class="bomb-img" src="{% static 'botaooff.png' %}" alt="ESP32">
    </div>

    <p class="status">Funcionamento: <span id="current">{{ mode }}</span></p>

    <script>
      let currentMode = "{{ mode }}";
      let esp32LastSeen = Date.now();
      window.esp32Online = false;

      const bombas = [
        {id: 'ronaldo', imgOn: '{% static "torneira_on.png" %}', imgOff: '{% static "torneira_off.png" %}'},
        {id: 'nene', imgOn: '{% static "torneira_on.png" %}', imgOff: '{% static "torneira_off.png" %}'},
        {id: 'eber', imgOn: '{% static "torneira_on.png" %}', imgOff: '{% static "torneira_off.png" %}'},
      ];

      const aguaImg = {imgOn: '{% static "motor_on.png" %}', imgOff: '{% static "motor_off.png" %}'};
      const esp32Img = {imgOn: '{% static "botaoon.png" %}', imgOff: '{% static "botaooff.png" %}'};

      function updateIndicators() {
        bombas.forEach(b => {
          const el = document.getElementById(b.id + '-img');
          el.src = (currentMode === b.id) ? b.imgOn : b.imgOff;
        });

        const aguaEl = document.getElementById('agua-img');
        aguaEl.src = (currentMode === 'none') ? aguaImg.imgOff : aguaImg.imgOn;

        const esp32El = document.getElementById('esp32-img');
        // Timeout de 30s sem resposta → desliga
        if (Date.now() - esp32LastSeen > 30000) {
          window.esp32Online = false;
        }
        esp32El.src = window.esp32Online ? esp32Img.imgOn : esp32Img.imgOff;

        document.getElementById('current').innerText = currentMode;
      }

      async function fetchState() {
        try {
          const res = await fetch('/api/state/');
          const j = await res.json();
          currentMode = j.mode || 'none';
          window.esp32Online = true;  // cada fetch bem-sucedido indica online
          esp32LastSeen = Date.now();
          updateIndicators();
        } catch (e) {
          console.error("Erro ao buscar estado:", e);
        }
      }

      async function setMode(mode) {
        try {
          await fetch('/api/set_mode/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode })
          });
          await fetchState();
        } catch (e) {
          console.error("Erro ao setar mode:", e);
        }
      }

      bombas.forEach(b => {
        document.getElementById(b.id + '-img').addEventListener('click', () => {
          setMode(currentMode === b.id ? 'none' : b.id);
        });
      });

      document.getElementById('agua-img').addEventListener('click', () => {});

      // Inicializa indicadores
      updateIndicators();

      // Loops periódicos
      setInterval(fetchState, 2000);
      setInterval(updateIndicators, 1000);
    </script>
  </body>
</html>
